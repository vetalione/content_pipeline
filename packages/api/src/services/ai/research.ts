import OpenAI from 'openai';
import { prisma } from '../../lib/db';
import { PipelineStage, ResearchData, BiographyFact } from '@content-pipeline/shared';

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY
});

/**
 * Perform research on a celebrity
 */
export async function performResearch(articleId: string): Promise<ResearchData> {
  const article = await prisma.article.findUnique({
    where: { id: articleId }
  });
  
  if (!article) {
    throw new Error('Article not found');
  }
  
  console.log(`Researching ${article.celebrityName}...`);
  
  // Create research prompt
  const prompt = createResearchPrompt(article.celebrityName);
  
  // Call OpenAI with timeout
  console.log('Calling OpenAI API for research...');
  
  let completion: OpenAI.Chat.Completions.ChatCompletion;
  
  try {
    completion = await Promise.race([
      openai.chat.completions.create({
        model: 'gpt-4o',
        messages: [
          {
            role: 'system',
            content: `–¢—ã —ç–∫—Å–ø–µ—Ä—Ç-–∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –ø–æ–∏—Å–∫–µ –ö–û–ù–ö–†–ï–¢–ù–´–• –¥—Ä–∞–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–∫—Ç–æ–≤ –æ –∑–Ω–∞–º–µ–Ω–∏—Ç–æ—Å—Ç—è—Ö –¥–ª—è —Å—Ç–∞—Ç–µ–π –≤ —Å—Ç–∏–ª–µ "Great Losers" (–∫–∞–Ω–∞–ª –Ω–∞ –î–∑–µ–Ω).

–¶–ï–õ–¨ –ò–°–°–õ–ï–î–û–í–ê–ù–ò–Ø:
–°–æ–±—Ä–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª –¥–ª—è —Å—Ç–∞—Ç—å–∏ —Ñ–æ—Ä–º–∞—Ç–∞ "[N] –Ω–µ—É–¥–∞—á [–ò–ú–Ø]". –ß–∏—Ç–∞—Ç–µ–ª—å –∑–Ω–∞–µ—Ç –≥–µ—Ä–æ—è –∫–∞–∫ —É—Å–ø–µ—à–Ω—É—é –ª–∏—á–Ω–æ—Å—Ç—å, –Ω–æ –º—ã –ø–æ–∫–∞–∂–µ–º —Å–∫—Ä—ã—Ç—ã–π –ø—É—Ç—å —á–µ—Ä–µ–∑ –ø—Ä–æ–≤–∞–ª—ã.

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –∏—â–∏ –¢–û–õ–¨–ö–û:
‚úÖ –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –Ω–µ—É–¥–∞—á–∏ —Å —Ü–∏—Ñ—Ä–∞–º–∏, –¥–∞—Ç–∞–º–∏, —Å—É–º–º–∞–º–∏
‚úÖ –î—Ä–∞–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∏–∑—à–∏–µ —Ç–æ—á–∫–∏ –∫–∞—Ä—å–µ—Ä—ã (–û–°–û–ë–ï–ù–ù–û –≤ –¥–µ—Ç—Å—Ç–≤–µ/—é–Ω–æ—Å—Ç–∏!)
‚úÖ –°–∫–∞–Ω–¥–∞–ª—ã, –ø—Ä–æ–≤–∞–ª—ã, –±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–∞, –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚úÖ –¢—é—Ä—å–º–∞, –±–µ–¥–Ω–æ—Å—Ç—å, –∏–∑–¥–µ–≤–∞—Ç–µ–ª—å—Å—Ç–≤–∞, —Ç—Ä–∞–≤–º—ã
‚úÖ –û—Ç–∫–∞–∑—ã, —É–≤–æ–ª—å–Ω–µ–Ω–∏—è, –∫—Ä–∏—Ç–∏–∫–∞
‚úÖ –ö–æ–Ω—Ç—Ä–∞—Å—Ç—ã: "–±—ã–ª –Ω–∏–∫–µ–º ‚Üí —Å—Ç–∞–ª –∑–≤–µ–∑–¥–æ–π"

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —É–∫–∞–∑—ã–≤–∞–π:
- –¢–æ—á–Ω—ã–π –í–û–ó–†–ê–°–¢ –≤ –º–æ–º–µ–Ω—Ç —Å–æ–±—ã—Ç–∏—è (–¥–ª—è —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞!)
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å—É–º–º—ã –¥–µ–Ω–µ–≥
- –°–∫–æ–ª—å–∫–æ –¥–Ω–µ–π/–º–µ—Å—è—Ü–µ–≤/–ª–µ—Ç –¥–ª–∏–ª–æ—Å—å
- –ò–º–µ–Ω–∞ –ª—é–¥–µ–π, –º–µ—Å—Ç, –∫–æ–º–ø–∞–Ω–∏–π
- –¶–∏—Ç–∞—Ç—ã –≥–µ—Ä–æ—è (–µ—Å–ª–∏ –µ—Å—Ç—å)

–û–°–û–ë–û–ï –í–ù–ò–ú–ê–ù–ò–ï:
üéØ **–î–ï–¢–°–¢–í–û/–Æ–ù–û–°–¢–¨** - –∏—â–∏ —Ä–µ–¥–∫–∏–µ –¥–µ—Ç—Å–∫–∏–µ —Ñ–æ—Ç–æ, —Ñ–∞–∫—Ç—ã –∏–∑ —à–∫–æ–ª—ã, –ø–µ—Ä–≤–æ–π —Ä–∞–±–æ—Ç—ã
üéØ **–•–†–û–ù–û–õ–û–ì–ò–Ø** - –æ—Ç –¥–µ—Ç—Å—Ç–≤–∞ –∫ —Ç–µ–∫—É—â–µ–º—É –º–æ–º–µ–Ω—Ç—É (–≤–æ–∑—Ä–∞—Å—Ç –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω!)
üéØ **–¢–ò–ó–ï–†** - —Ñ–∞–∫—Ç –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∞–±–∑–∞—Ü–∞: "—á–µ–º –∏–∑–≤–µ—Å—Ç–µ–Ω + –º–∞–ª–æ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∏–Ω—Ç—Ä–∏–≥–∞"

‚ùå –ù–ï –ù–£–ñ–ù–´ –æ–±—â–∏–µ —Ñ—Ä–∞–∑—ã —Ç–∏–ø–∞ "—Å—Ç–æ–ª–∫–Ω—É–ª—Å—è —Å —Ç—Ä—É–¥–Ω–æ—Å—Ç—è–º–∏"
‚úÖ –ù–£–ñ–ù–´ –¥–µ—Ç–∞–ª–∏ —Ç–∏–ø–∞ "–ø–æ—Ç–µ—Ä—è–ª $500,000", "–ø—Ä–æ–≤—ë–ª 113 –¥–Ω–µ–π –≤ —Ç—é—Ä—å–º–µ", "–≤ 14 –ª–µ—Ç —Ä–∞–±–æ—Ç–∞–ª —Ä–∞–∑–Ω–æ—Å—á–∏–∫–æ–º –≥–∞–∑–µ—Ç"

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞: –º–∏–Ω–∏–º—É–º 8-10 –¥—Ä–∞–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–∫—Ç–æ–≤-–Ω–µ—É–¥–∞—á –í –•–†–û–ù–û–õ–û–ì–ò–ß–ï–°–ö–û–ú –ü–û–†–Ø–î–ö–ï + –∏—Ç–æ–≥–æ–≤—ã–π —É—Å–ø–µ—Ö —Å —Ü–∏—Ñ—Ä–∞–º–∏`
          },
          {
            role: 'user',
            content: prompt
          }
        ],
        temperature: 0.7,
        max_tokens: 16000,
        response_format: { type: 'json_object' }
      }),
      new Promise<never>((_, reject) => 
        setTimeout(() => reject(new Error('OpenAI API timeout after 3 minutes')), 180000)
      )
    ]);
    
    console.log('OpenAI response received, parsing JSON...');
  } catch (error) {
    console.error('OpenAI API error:', error);
    throw new Error(`Research failed: ${error instanceof Error ? error.message : 'Unknown error'}`);
  }
  
  const researchData = JSON.parse(completion.choices[0].message.content || '{}');
  
  // Save to database
  await prisma.article.update({
    where: { id: articleId },
    data: {
      researchData,
      currentStage: PipelineStage.RESEARCH,
      updatedAt: new Date()
    }
  });
  
  return researchData;
}

function createResearchPrompt(celebrityName: string): string {
  return `
–ò—Å—Å–ª–µ–¥—É–π –∂–∏–∑–Ω—å ${celebrityName} –∏ –Ω–∞–π–¥–∏ –º–∏–Ω–∏–º—É–º 8-10 –ö–û–ù–ö–†–ï–¢–ù–´–• –¥—Ä–∞–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –Ω–µ—É–¥–∞—á/–ø—Ä–æ–≤–∞–ª–æ–≤.

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ô JSON —Ñ–æ—Ä–º–∞—Ç:

{
  "teaser": {
    "known_for": "–ß–µ–º –∑–Ω–∞–º–µ–Ω–∏—Ç –∏ –ª—é–±–∏–º –≤—Å–µ–º –º–∏—Ä–æ–º (2-3 —Ñ–∞–∫—Ç–∞)",
    "hidden_drama": "–ú–∞–ª–æ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –¥—Ä–∞–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤–æ—Ä–æ—Ç—ã —Å—É–¥—å–±—ã (–∏–Ω—Ç—Ä–∏–≥–∞ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∞–±–∑–∞—Ü–∞)",
    "childhood_photo_hint": "–û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–¥–∫–æ–≥–æ –¥–µ—Ç—Å–∫–æ–≥–æ —Ñ–æ—Ç–æ, –∫–æ—Ç–æ—Ä–æ–µ –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏"
  },
  "failures": [
    {
      "number": 1,
      "title": "–ö—Ä–∞—Ç–∫–∏–π —Ü–µ–ø–ª—è—é—â–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –¥–µ—Ç–∞–ª—å—é",
      "age": "–≤–æ–∑—Ä–∞—Å—Ç –∫–æ–≥–¥–∞ —ç—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–ª—è —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏–∏!)",
      "year": "–≥–æ–¥ —Å–æ–±—ã—Ç–∏—è",
      "description": "–î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–æ –≤—Å–µ–º–∏ —Ü–∏—Ñ—Ä–∞–º–∏, —Å—É–º–º–∞–º–∏, —Å—Ä–æ–∫–∞–º–∏",
      "outcome": "—á—Ç–æ –∏–∑ —ç—Ç–æ–≥–æ –≤—ã—à–ª–æ",
      "severity": 1-5,
      "visual_suggestion": "–ö–∞–∫–æ–µ —Ñ–æ—Ç–æ/–≥–∏—Ñ–∫—É/–º–µ–º –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –¥–ª—è —ç—Ç–æ–≥–æ –ø—É–Ω–∫—Ç–∞"
    }
  ],
  "quotes": [
    {
      "text": "–¢–æ—á–Ω–∞—è —Ü–∏—Ç–∞—Ç–∞ –≥–µ—Ä–æ—è",
      "context": "–ö–æ–≥–¥–∞ –∏ –ø–æ—á–µ–º—É –æ–Ω —ç—Ç–æ —Å–∫–∞–∑–∞–ª",
      "source": "–û—Ç–∫—É–¥–∞ —Ü–∏—Ç–∞—Ç–∞",
      "suitable_for_ending": true/false
    }
  ],
  "success": {
    "peak_achievement": "–ì–ª–∞–≤–Ω–æ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Å —Ü–∏—Ñ—Ä–∞–º–∏",
    "current_status": "–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å",
    "wealth": "–°–æ—Å—Ç–æ—è–Ω–∏–µ/–≥–æ–Ω–æ—Ä–∞—Ä—ã —Å —Å—É–º–º–∞–º–∏",
    "awards": ["—Å–ø–∏—Å–æ–∫ –Ω–∞–≥—Ä–∞–¥"],
    "personal_life": "–°–µ–º—å—è, –¥–µ—Ç–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)"
  },
  "bonus_fact": "–ó–∞–±–∞–≤–Ω—ã–π –∏–ª–∏ —à–æ–∫–∏—Ä—É—é—â–∏–π –º–∞–ª–æ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–∞–∫—Ç",
  "timeline": "–ö—Ä–∞—Ç–∫–∞—è —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—è: –æ—Ç [—Ö—É–¥—à–µ–µ] –≤ [–≤–æ–∑—Ä–∞—Å—Ç/–≥–æ–¥] –¥–æ [–ª—É—á—à–µ–µ] –≤ [–≤–æ–∑—Ä–∞—Å—Ç/–≥–æ–¥]",
  "sources": ["–∏—Å—Ç–æ—á–Ω–∏–∫1", "–∏—Å—Ç–æ—á–Ω–∏–∫2"]
}

–ö–†–ò–¢–ò–ß–ù–û - –∫–∞–∂–¥–∞—è –Ω–µ—É–¥–∞—á–∞ –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
- –¢–æ—á–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç –∏–ª–∏ –≥–æ–¥ (–¥–ª—è –≤—ã—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—è –•–†–û–ù–û–õ–û–ì–ò–ò –æ—Ç –¥–µ—Ç—Å—Ç–≤–∞ –∫ –≤–∑—Ä–æ—Å–ª–æ–º—É)
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã (–¥–µ–Ω—å–≥–∏, –¥–Ω–∏, –∫–∏–ª–æ–º–µ—Ç—Ä—ã, —á—Ç–æ —É–≥–æ–¥–Ω–æ)
- –î—Ä–∞–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ —Å –∏—Ä–æ–Ω–∏–µ–π
- –ù–∏–∫–∞–∫–∏—Ö –æ–±—â–∏—Ö —Ñ—Ä–∞–∑!

–ü–û–†–Ø–î–û–ö –ù–ï–£–î–ê–ß - –°–¢–†–û–ì–û –•–†–û–ù–û–õ–û–ì–ò–ß–ï–°–ö–ò–ô:
- –ù–∞—á–∏–Ω–∞–π —Å –¥–µ—Ç—Å—Ç–≤–∞ (5-7 –ª–µ—Ç)
- –ó–∞—Ç–µ–º —à–∫–æ–ª–∞/—é–Ω–æ—Å—Ç—å (10-16 –ª–µ—Ç)
- –ú–æ–ª–æ–¥–æ—Å—Ç—å –∏ –ø–µ—Ä–≤–∞—è —Ä–∞–±–æ—Ç–∞ (17-25 –ª–µ—Ç)
- –ó—Ä–µ–ª–æ—Å—Ç—å –∏ –∫–∞—Ä—å–µ—Ä–∞ (25+ –ª–µ—Ç)

–ü—Ä–∏–º–µ—Ä—ã –•–û–†–û–®–ò–• –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤:
‚úÖ "–í 5 –ª–µ—Ç –ø—Ä–∏—à–ª–æ—Å—å –∑–∞–º–µ–Ω—è—Ç—å –º–∞–º—É –Ω–∞ —Å—Ü–µ–Ω–µ" (–ß–∞–ø–ª–∏–Ω)
‚úÖ "–° 14 –ª–µ—Ç —Ä–∞–±–æ—Ç–∞–ª —É–±–æ—Ä—â–∏–∫–æ–º" (–ö–µ—Ä—Ä–∏)
‚úÖ "–ü—Ä–æ–≤—ë–ª 113 –¥–Ω–µ–π –≤ –Ω–∞—Å—Ç–æ—è—â–µ–π —Ç—é—Ä—å–º–µ" (–î–∞—É–Ω–∏)
‚úÖ "–í 30 –ª–µ—Ç –ø–æ–¥–º–µ—Ç–∞–ª —É–ª–∏—Ü—ã, —Ä—ã–ª –∫–∞–Ω–∞–≤—ã" (–¢–µ—Å–ª–∞)

–ü—Ä–∏–º–µ—Ä—ã –ü–õ–û–•–ò–• –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤:
‚ùå "–ò—Å–ø—ã—Ç–∞–ª —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏"
‚ùå "–°—Ç–æ–ª–∫–Ω—É–ª—Å—è —Å –ø—Ä–æ–±–ª–µ–º–∞–º–∏"
‚ùå "–ü–µ—Ä–µ–∂–∏–ª —Å–ª–æ–∂–Ω—ã–π –ø–µ—Ä–∏–æ–¥"

–§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞:
- –î–µ—Ç—Å—Ç–≤–æ: –±–µ–¥–Ω–æ—Å—Ç—å, –ø—Ä–∏—é—Ç—ã, —Ä–∞–∑–≤–æ–¥ —Ä–æ–¥–∏—Ç–µ–ª–µ–π, —à–∫–æ–ª—å–Ω—ã–µ –∏–∑–¥–µ–≤–∞—Ç–µ–ª—å—Å—Ç–≤–∞
- –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, –±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–∞, —Ç—é—Ä—å–º–∞
- –û—Ç–∫–∞–∑—ã, —É–≤–æ–ª—å–Ω–µ–Ω–∏—è, –ø—Ä–æ–≤–∞–ª—å–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã
- –¢—Ä–∞–≤–º—ã, –±–æ–ª–µ–∑–Ω–∏, –ø–æ—Ç–µ—Ä–∏ –±–ª–∏–∑–∫–∏—Ö
- –°–∫–∞–Ω–¥–∞–ª—ã, —Å—É–¥–µ–±–Ω—ã–µ –¥–µ–ª–∞
- –ë–µ–¥–Ω–æ—Å—Ç—å, –¥–æ–ª–≥–∏, –±–µ–∑–¥–æ–º–Ω–æ—Å—Ç—å

–ò—Å—Ç–æ—Ä–∏—è –¥–æ–ª–∂–Ω–∞ –∏–º–µ—Ç—å —Ö—ç–ø–ø–∏-—ç–Ω–¥ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Ü–∏—Ñ—Ä–∞–º–∏ —É—Å–ø–µ—Ö–∞! –ò —Ñ–∏–Ω–∞–ª—å–Ω–∞—è —Ü–∏—Ç–∞—Ç–∞ –≥–µ—Ä–æ—è –æ –ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–∏.
`;
}

